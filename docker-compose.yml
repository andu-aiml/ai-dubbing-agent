version: "3.9"

# =============================================================================
# Hindi-to-English Dubbing Pipeline
# Each service runs in isolation to avoid dependency conflicts.
# =============================================================================

networks:
  dubbing_net:
    driver: bridge

volumes:
  shared_data: # temp files between services
  whisper_models: # cached Whisper model weights
  tts_models: # cached Coqui XTTS model weights
  wav2lip_models:
    # Wav2Lip checkpoint files

services:

  # ---------------------------------------------------------------------------
  # Service 1: ASR + Translation (openai-whisper)
  # Python 3.10 | Port 8001
  # ---------------------------------------------------------------------------
  asr:
    build:
      context: ./services/asr
      dockerfile: Dockerfile
    image: dubbing-asr:latest
    container_name: dubbing_asr
    ports:
      - "8001:8001"
    volumes:
      - shared_data:/shared
      - whisper_models:/root/.cache/whisper
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - DEVICE=${DEVICE:-cpu}
    networks:
      - dubbing_net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Service 2: Voice Cloning TTS (Coqui XTTS-v2)
  # Python 3.10 | Port 8002
  # ---------------------------------------------------------------------------
  tts:
    build:
      context: ./services/tts
      dockerfile: Dockerfile
    image: dubbing-tts:latest
    container_name: dubbing_tts
    ports:
      - "8002:8002"
    volumes:
      - shared_data:/shared
      - tts_models:/root/.local/share/tts
    environment:
      - DEVICE=${DEVICE:-cpu}
      - TTS_MODEL=${TTS_MODEL:-tts_models/multilingual/multi-dataset/xtts_v2}
    networks:
      - dubbing_net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s # TTS model loading + download takes time
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Service 3: Lip Sync (Wav2Lip)
  # Python 3.8 | Port 8003
  # ---------------------------------------------------------------------------
  wav2lip:
    build:
      context: ./services/wav2lip
      dockerfile: Dockerfile
    image: dubbing-wav2lip:latest
    container_name: dubbing_wav2lip
    ports:
      - "8003:8003"
    volumes:
      - shared_data:/shared
      - ./models/wav2lip:/app/Wav2Lip/checkpoints
    environment:
      - DEVICE=${DEVICE:-cpu}
    networks:
      - dubbing_net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8003/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
